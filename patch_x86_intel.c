// arch/x86/kvm/x86.c

u8 passthrough_msrs_bitmap[] = {
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0018
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0038
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0058
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0078
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0098
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x00B8
	0b00000110, 0b01000000, 0b00000000, 0b00000000, // 0x00D8
	0b10000000, 0b00000001, 0b00000000, 0b00000000, // 0x00F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0118
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0138
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0158
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0178
	0b00000000, 0b00000000, 0b00000000, 0b00111111, // 0x0198
	0b00000000, 0b11100000, 0b00000010, 0b00000000, // 0x01B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x01D8
	0b00000000, 0b00000000, 0b00000000, 0b00010000, // 0x01F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0218
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0238
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0258
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0278
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0298
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x02B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x02D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x02F8
	0b00000000, 0b00011110, 0b00000000, 0b00000000, // 0x0318
	0b00000000, 0b00000010, 0b00000000, 0b00000000, // 0x0338
	0b00100000, 0b00000000, 0b00000000, 0b00000000, // 0x0358
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0378
	0b00000000, 0b11100000, 0b00000001, 0b00000000, // 0x0398
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x03B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x03D8
	0b00000000, 0b00000000, 0b00000000, 0b11110111, // 0x03F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0418
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0438
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0458
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0478
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0498
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x04B8
	0b00000010, 0b00000000, 0b00000000, 0b00000000, // 0x04D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x04F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0518
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0538
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0558
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0578
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0598
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x05B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x05D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x05F8
	0b01000010, 0b00111100, 0b00011011, 0b00011011, // 0x0618
	0b00000000, 0b00000000, 0b00111111, 0b00001111, // 0x0638
	0b00000111, 0b11111111, 0b00000001, 0b00001111, // 0x0658
	0b00010001, 0b00111111, 0b00000000, 0b00000000, // 0x0678
	0b00000000, 0b00000000, 0b00000001, 0b00000000, // 0x0698
	0b00000000, 0b00000000, 0b00000011, 0b00000000, // 0x06B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x06D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x06F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0718
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0738
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0758
	0b00000000, 0b00000000, 0b10011111, 0b00000000, // 0x0778
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0798
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x07B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x07D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x07F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0818
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0838
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0858
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0878
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0898
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x08B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x08D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x08F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0918
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0938
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0958
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0978
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0998
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x09B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x09D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x09F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0A18
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0A38
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0A58
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0A78
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0A98
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0AB8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0AD8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0AF8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0B18
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0B38
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0B58
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0B78
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0B98
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0BB8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0BD8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0BF8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0C18
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0C38
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0C58
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0C78
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0C98
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0CB8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0CD8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0CF8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0D18
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0D38
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0D58
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0D78
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0D98
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0DB8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0DD8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0DF8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0E18
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0E38
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0E58
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0E78
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0E98
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0EB8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0ED8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0EF8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0F18
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0F38
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0F58
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0F78
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0F98
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0FB8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0FD8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x0FF8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1018
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1038
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1058
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1078
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1098
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x10B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x10D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x10F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1118
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1138
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1158
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1178
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1198
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x11B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x11D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x11F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1218
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1238
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1258
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1278
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1298
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x12B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x12D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x12F8
	0b00000000, 0b00000010, 0b00000000, 0b00000000, // 0x1318
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1338
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1358
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1378
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1398
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x13B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x13D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x13F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1418
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1438
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1458
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1478
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1498
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x14B8
	0b00000010, 0b00000000, 0b00000000, 0b00000000, // 0x14D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x14F8
	0b00000010, 0b00000000, 0b00000000, 0b00000000, // 0x1518
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1538
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1558
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1578
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1598
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x15B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x15D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x15F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1618
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1638
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1658
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1678
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1698
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x16B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x16D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x16F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1718
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1738
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1758
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1778
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1798
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x17B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x17D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x17F8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1818
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1838
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1858
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1878
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1898
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x18B8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x18D8
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x18F8
	0b00001111, 0b00000000, 0b00000000, 0b00000000, // 0x1918
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1938
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1958
	0b00000000, 0b00000000, 0b00000000, 0b00000000, // 0x1978
	0b00001101 // 0x1980
};

int is_msr_passthrough(u32 index);
u64 read_host_msr(u32 index);
void write_host_msr(u32 index, u64 data);

int is_msr_passthrough(u32 index)
{
	if ((index < sizeof(passthrough_msrs_bitmap) * 8) &&
	    passthrough_msrs_bitmap[index >> 3] & (1 << (index & 7)))
		return 1;
	return 0;
}

u64 read_host_msr(u32 index)
{
	u32 low, high;
	__asm__ volatile("rdmsr" : "=a"(low), "=d"(high) : "c"(index));
	return (((u64)high) << 32) | low;
}

void write_host_msr(u32 index, u64 data)
{
	u32 low, high;
	low = data & 0xffffffff;
	high = data >> 32;
	__asm__ volatile("wrmsr" : : "a"(low), "d"(high), "c"(index));
}

int kvm_emulate_rdmsr(struct kvm_vcpu *vcpu)
{
	u32 ecx = kvm_rcx_read(vcpu);
	u64 data;
	int r;

	r = kvm_get_msr_with_filter(vcpu, ecx, &data);

	if (is_msr_passthrough(ecx)) {
		r = 0;
		data = read_host_msr(ecx);
	}

	if (!r) {
		trace_kvm_msr_read(ecx, data);

		kvm_rax_write(vcpu, data & -1u);
		kvm_rdx_write(vcpu, (data >> 32) & -1u);
	} else {
		/* MSR read failed? See if we should ask user space */
		if (kvm_msr_user_space(vcpu, ecx, KVM_EXIT_X86_RDMSR, 0,
				       complete_fast_rdmsr, r))
			return 0;
		trace_kvm_msr_read_ex(ecx);
	}

	return kvm_x86_call(complete_emulated_msr)(vcpu, r);
}
